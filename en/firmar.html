<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="favicon.png" />
    <title>
      Spanish Inter-University Network of Solidarity with Palestine<br>
      #NotMyUniversity/ليست_جامعتي # Campaign
    </title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.4/css/bulma.min.css"
    />
    <script src="https://www.google.com/recaptcha/api.js?render=6Ld3jAcpAAAAAOzkkkPys23rYGu50w9cXtFQg0uI"></script>
  </head>
  <body>
    <nav
      class="navbar is-success"
      role="navigation"
      aria-label="main navigation"
    >
      <div class="navbar-brand">
        <a class="navbar-item" href="./index.html"> Manifesto </a>
        <a
          role="button"
          class="navbar-burger"
          aria-label="menu"
          aria-expanded="false"
          data-target="navbarBasicExample"
        >
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div id="navbarBasicExample" class="navbar-menu">
        <div class="navbar-start">
          <a class="navbar-item" href="./firmar.html"> Sign the petition </a>
          <a class="navbar-item" href="./firmantes.html">
            Current signatories
          </a>
          <a class="navbar-item" href="./validar.html"> Validate signature </a>
        </div>
        <div class="navbar-end">
          <a class="navbar-item" href="/index.html"> ES </a>
          <a class="navbar-item" href="/gl/index.html"> GL </a>
          <a class="navbar-item" href="/eu/index.html"> EU </a>
          <a class="navbar-item has-text-weight-bold" href="/en/index.html">
            EN
          </a>
          <a class="navbar-item" href="/ca/index.html"> CA </a>
        </div>
      </div>
    </nav>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Get all "navbar-burger" elements
        const $navbarBurgers = Array.prototype.slice.call(
          document.querySelectorAll(".navbar-burger"),
          0
        );

        // Check if there are any navbar burgers
        if ($navbarBurgers.length > 0) {
          // Add a click event on each of them
          $navbarBurgers.forEach((el) => {
            el.addEventListener("click", () => {
              // Get the target from the "data-target" attribute
              const target = el.dataset.target;
              const $target = document.getElementById(target);

              // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
              el.classList.toggle("is-active");
              $target.classList.toggle("is-active");
            });
          });
        }
      });
    </script>
    <section class="hero is-success">
      <div class="hero-body">
        <div class="container">
          <h1 class="title">
            Spanish Inter-University Network of Solidarity with Palestine<br />
            #NotMyUniversity/ليست_جامعتي # Campaign
          </h1>
          <h2 class="subtitle is-size-3">Sign the manifesto</h2>
        </div>
      </div>
    </section>
    <section class="section">
      <div class="container">
        <h1 class="title">Signature data</h1>
        <p class="has-text-danger my-4">
          Fields marked with an asterisk
          <span class="has-text-danger">*</span> are obligatory
        </p>
        <form id="firmar-form" method="POST">
          <div class="field">
            <label class="label"
              >Name <span class="has-text-danger">*</span></label
            >
            <div class="control">
              <input class="input" type="text" name="nombre" required />
            </div>
          </div>
          <div class="field">
            <label class="label"
              >Surname <span class="has-text-danger">*</span></label
            >
            <div class="control">
              <input class="input" type="text" name="apellido1" required />
            </div>
          </div>
          <div class="field">
            <label class="label"
              >Second surname <span class="has-text-danger">*</span></label
            >
            <div class="control">
              <input class="input" type="text" name="apellido2" required />
              <p class="help is-info">
                If you do not have a second surname, please enter a blank space.
              </p>
            </div>
          </div>
          <div class="field">
            <label class="label"
              >Affiliation
              <span class="has-text-grey-light"
                >(Name of your university, reasearch centre, etc.)</span
              >
              <span class="has-text-danger">*</span></label
            >
            <div class="control">
              <input class="input" type="text" name="afiliacion" required />
            </div>
          </div>
          <div class="field">
            <label class="label"
              >DNI/NIE
              <span class="has-text-grey-light"
                >(The data provided in this field will not be made public, see
                <a
                  href="./privacidad.html"
                  target="_blank"
                  onclick="window.open('./privacidad.html', 'Privacy Policy', 'width=600,height=400'); return false;"
                >
                  Privacy policy </a
                >)</span
              >
              <span class="has-text-danger">*</span></label
            >
            <div class="control">
              <input class="input" type="text" name="dni" required />
              <p class="help is-danger" id="dni-error" style="display: none">
                DNI/NIE is invalid
              </p>
            </div>
          </div>
          <div class="field">
            <label class="label"
              >E-mail
              <span class="has-text-grey-light"
                >(The data provided in this field will not be made public, see
                <a
                  href="./privacidad.html"
                  target="_blank"
                  onclick="window.open('./privacidad.html', 'Privacy Policy', 'width=600,height=400'); return false;"
                >
                  Privacy policy </a
                >)</span
              >
              <span class="has-text-danger">*</span></label
            >
            <div class="control">
              <input class="input" type="email" name="email" required />
            </div>
          </div>
          <div class="field">
            <label class="label"
              >Employee category<span class="has-text-danger">*</span></label
            >
            <div class="control">
              <div class="select">
                <select name="ocupacion" required>
                  <option value="" disabled selected>
                    Choose one of the following options
                  </option>
                  <option value="Docente e Investigador/a">
                    Teaching/research staff
                  </option>
                  <option value="Investigador/a contratado/a">
                    Contract researcher
                  </option>
                  <option value="Estudiante">Student</option>
                  <option value="Personal de administración y servicios">
                    Administrative and service staff
                  </option>
                  <option value="Personal de servicios subcontratados">
                    Subcontracted service staff
                  </option>
                </select>
              </div>
            </div>
          </div>
          <div class="field">
            <div class="control">
              <label class="checkbox">
                <input type="checkbox" name="aceptar-email" />
                I would like to receive information about future actions.
              </label>
            </div>
          </div>
          <div class="field">
            <div class="control">
              <label class="checkbox">
                <input type="checkbox" name="conformidad" required />
                I accept the
                <a
                  href="./privacidad.html"
                  target="_blank"
                  onclick="window.open('./privacidad.html', 'Privacy Policy', 'width=600,height=400'); return false;"
                >
                  privacy policy
                  <span class="has-text-danger">*</span>
                </a>
              </label>
            </div>
          </div>
          <div class="field">
            <div class="control">
              <button class="button is-primary" type="submit">
                Submit signature
              </button>
            </div>
          </div>
        </form>
      </div>
      <div id="modal-firma" class="modal">
        <div class="modal-background"></div>
        <div class="modal-content">
          <div class="box">
            <p>
              The signature has been sent correctly, thank-you for your support.
            </p>
            <p class="mt-2">
              To validate it, use the code sent by email; if you can't find it,
              please check your spam folder.
            </p>
            <p class="mt-2">
              You can validate your signature with the code received by e-mail
              on the following page:
            </p>
            <div class="field mt-4">
              <div class="control">
                <a href="./validar.html">
                  <button class="button is-primary">
                    Validate your signature
                  </button>
                </a>
              </div>
            </div>
          </div>
        </div>

        <button class="modal-close is-large" aria-label="close"></button>
      </div>
    </section>

    <!-- Add JavaScript for form validation -->
    <script>
      const form = document.getElementById("firmar-form");
      const dniInput = document.getElementsByName("dni")[0];
      const dniError = document.getElementById("dni-error");

      form.addEventListener("submit", (event) => {
        // Check that all fields are present
        const inputs = form.querySelectorAll("input, select");
        let isValid = true;
        inputs.forEach((input) => {
          if (!input.value) {
            isValid = false;
            input.classList.add("is-danger");
          } else {
            input.classList.remove("is-danger");
          }
        });

        // Check that DNI/NIE is valid
        if (!validarDNI(dniInput.value)) {
          isValid = false;
          dniInput.classList.add("is-danger");
          dniError.style.display = "block";
        } else {
          dniInput.classList.remove("is-danger");
          dniError.style.display = "none";
        }

        if (!isValid) {
          event.preventDefault();
        } else {
          event.preventDefault();

          // Obtener los valores de los campos del formulario
          const name = document.querySelector('input[name="nombre"]').value;
          const surname1 = document.querySelector(
            'input[name="apellido1"]'
          ).value;
          const surname2 = document.querySelector(
            'input[name="apellido2"]'
          ).value;
          const email = document.querySelector('input[name="email"]').value;
          const dni = document.querySelector('input[name="dni"]').value;
          const affiliation = document.querySelector(
            'input[name="afiliacion"]'
          ).value;
          const occupation = document.querySelector(
            'select[name="ocupacion"]'
          ).value;
          const subscribedNewsletter = document.querySelector(
            'input[name="aceptar-email"]'
          ).checked;

          const surname = surname2 ? `${surname1} ${surname2}` : surname1;
          // Crear un objeto con los valores obtenidos
          const data = {
            name: name,
            surname: surname,
            email: email,
            dni: dni,
            affiliation: affiliation,
            occupation: occupation,
            subscribedNewsletter: subscribedNewsletter,
          };

          // Convertir el objeto a formato JSON
          const jsonData = JSON.stringify(data);

          grecaptcha.ready(function () {
            grecaptcha
              .execute("6Ld3jAcpAAAAAOzkkkPys23rYGu50w9cXtFQg0uI", {
                action: "submit",
              })
              .then(function (token) {
                // Enviar los datos al servidor con fetch
                // Hacer un post sobre HTTPS a un dominio definido en una variable en la ruta /signatures
                const url = "https://api.notmyuniversity.org/signatures";
                fetch(url, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    "g-recaptcha-response": token,
                  },
                  body: jsonData,
                })
                  .then((response) => {
                    if (response.ok) {
                      // Mostrar un mensaje de éxito
                      // document.getElementById("modal-firma").classList.add("is-active");

                      // Redirigir a la página de validación
                      window.location.href = "./validar.html";
                    } else {
                      response.json().then((data) => {
                        alert(
                          `An error occurred on sending the signature: ${data.message}`
                        );
                      });
                    }
                  })
                  .catch((error) => {
                    alert("An error occurred on sending the signature");
                  });
              });
          });
        }
      });

      function validarDNI(dni) {
        //Verificamos que el DNI tenga 9 caracteres
        if (dni.length !== 9) {
          return false;
        }
        //Comprobar si es un NIE mirando la primera letra
        const firstLetter = dni.substr(0, 1).toUpperCase();
        if (isNaN(firstLetter)) {
          if (firstLetter === "X") {
            dni = dni.replace("X", "0");
          } else if (firstLetter === "Y") {
            dni = dni.replace("Y", "1");
          } else if (firstLetter === "Z") {
            dni = dni.replace("Z", "2");
          } else {
            return false;
          }
        }

        //Comprobar si el resto del DNI es numérico
        const numero = dni.substr(0, dni.length - 1);
        if (isNaN(numero)) {
          return false;
        }
        const letra = dni.substr(dni.length - 1, 1);
        //Hacemos un array con las letras posibles
        const letras = [
          "T",
          "R",
          "W",
          "A",
          "G",
          "M",
          "Y",
          "F",
          "P",
          "D",
          "X",
          "B",
          "N",
          "J",
          "Z",
          "S",
          "Q",
          "V",
          "H",
          "L",
          "C",
          "K",
          "E",
          "T",
        ];
        const letraCorrecta = letras[numero % 23];
        if (letraCorrecta !== letra) {
          return false;
        }

        return true;
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Functions to open and close a modal

        function closeModal($el) {
          $el.classList.remove("is-active");
        }

        function closeAllModals() {
          (document.querySelectorAll(".modal") || []).forEach(($modal) => {
            closeModal($modal);
          });
        }

        // Add a click event on various child elements to close the parent modal
        (
          document.querySelectorAll(
            ".modal-background, .modal-close, .modal-card-head .delete, .modal-card-foot .button"
          ) || []
        ).forEach(($close) => {
          const $target = $close.closest(".modal");

          $close.addEventListener("click", () => {
            closeModal($target);
          });
        });

        // Add a keyboard event to close all modals
        document.addEventListener("keydown", (event) => {
          if (event.code === "Escape") {
            closeAllModals();
          }
        });
      });
    </script>
  </body>
</html>
